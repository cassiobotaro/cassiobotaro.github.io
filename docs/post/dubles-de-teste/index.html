<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.110.0">

  <title>Dubl√™s de testes &middot; Import None</title>

  <meta name="description" content="Escrevendo dubl√™s para seus testes." />

  

<meta itemprop="name" content="Dubl√™s de testes">
<meta itemprop="description" content="Escrevendo dubl√™s para seus testes."><meta itemprop="datePublished" content="2020-09-19T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-09-19T00:00:00+00:00" />
<meta itemprop="wordCount" content="1235"><meta itemprop="image" content="http://cassiobotaro.dev/images/profile.png"/>
<meta itemprop="keywords" content="python,tests,dubles," />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://cassiobotaro.dev/images/profile.png"/>

<meta name="twitter:title" content="Dubl√™s de testes"/>
<meta name="twitter:description" content="Escrevendo dubl√™s para seus testes."/>


<meta property="og:title" content="Dubl√™s de testes" />
<meta property="og:description" content="Escrevendo dubl√™s para seus testes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://cassiobotaro.dev/post/dubles-de-teste/" /><meta property="og:image" content="http://cassiobotaro.dev/images/profile.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-09-19T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-09-19T00:00:00+00:00" /><meta property="og:site_name" content="Import None" />



<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type":"Person",
      "@id": "http://cassiobotaro.dev/#author",
      "name": "C√°ssio Botaro",
      "image": {
        "@type":"ImageObject",
        
        "url": "http://cassiobotaro.dev/images/profile.png"
        
      },
      "description": "..."
    },
    {
      "@type": "WebSite",
      "@id": "http://cassiobotaro.dev/#website",
      "url": "http://cassiobotaro.dev/",
      "name": "Import None",
      "description": "...",
      "publisher": {
        "@id": "http://cassiobotaro.dev/#author"
      },
      "inLanguage": ""
    },
    {
      "@type": "ImageObject",
      "url": "http://cassiobotaro.dev/images/profile.png",
      "caption": "Import None"
    },
    {
      "@type": "WebPage",
      "@id": "http://cassiobotaro.dev/post/dubles-de-teste/#webpage",
      "url": "http://cassiobotaro.dev/post/dubles-de-teste/",
      "name": "Dubl√™s de testes",
      "isPartOf": {
        "@id": "http://cassiobotaro.dev/#website"
      },
      "about": {
         "@id": "http://cassiobotaro.dev/#author"
      },
      "datePublished": "2020-09-19T00:00:00+00:00",
      "dateModified": "2020-09-19T00:00:00+00:00",
      "description": "Escrevendo dubl√™s para seus testes.",
      "inLanguage": "",
      "potentialAction": [
        {
          "@type": "ReadAction",
          "target": [
            "http://cassiobotaro.dev/post/dubles-de-teste/"
          ]
        }
      ]
    },
    {
      "@type": "Article",
      "isPartOf": {
        "@id": "http://cassiobotaro.dev/post/dubles-de-teste/#webpage"
      },
      "mainEntityOfPage": {
        "@id": "http://cassiobotaro.dev/post/dubles-de-teste/#webpage"
      },
      "headline": "Dubl√™s de testes",
      "datePublished": "2020-09-19T00:00:00+00:00",
      "dateModified": "2020-09-19T00:00:00+00:00",
      "publisher": {
        "@id": "http://cassiobotaro.dev/#author"
      },
      "keywords": [
        "python",
        "tests",
        "dubles"
      ],
      "articleSection": [
        "tests"
      ],
      "inLanguage": "",
      "author": {
        "@type": "Person",
        "name":  null 
      },
      "potentialAction": [
        {
          "@type": "CommentAction",
          "name": "Comment",
          "target": [
            "http://cassiobotaro.dev/post/dubles-de-teste/#comments"
          ]
        }
      ]
    }
  ]
}
</script>



  <link type="text/css"
        rel="stylesheet"
        href="/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="/css/hyde.css">

  
<style type="text/css">
  .sidebar {
    background-color: #333333;
  }

  .read-more-link a {
    border-color: #333333;
  }

  .read-more-link a:hover {
    background-color: #333333;
  }

  .pagination li a {
    color: #333333;
    border: 1px solid #333333;
  }

  .pagination li.active a {
    background-color: #333333;
  }

  .pagination li a:hover {
    background-color: #333333;
    opacity: 0.75;
  }

  footer a,
  .content a,
  .related-posts li a:hover {
    color: #333333;
  }
</style>



  

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <a href="http://cassiobotaro.dev/">
            <img src="/images/profile.png" class="img-circle img-headshot center" alt="Profile Picture">
          </a>
        </div>
        
      

      <h1>Import None</h1>

      
      <p class="lead">...</p>
      
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li>
          <a href="http://cassiobotaro.dev/">Home</a>
        </li>
        <li>
          <a href="/posts/">Posts</a>
        </li><li>
          <a href="/categories/">Categories</a>
        </li><li>
          <a href="/tags/">Tags</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
      <a href="https://www.linkedin.com/in/c%C3%A1ssio-botaro-6a2043b1/" rel="me" title="Linkedin" target="_blank">
        <i class="fab fa-linkedin" aria-hidden="true"></i>
      </a>
      
      <a href="http://github.com/cassiobotaro" rel="me" title="GitHub" target="_blank">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
      <a href="http://twitter.com/cassiobotaro" rel="me" title="Twitter" target="_blank">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <h1 class="title">Dubl√™s de testes</h1>
  

  <div class="post-date">
    <time datetime="2020-09-19T00:00:00Z">Sep 19, 2020</time> <span class="readtime">&middot; 6 min read</span>
  </div>

  <div>
  <p><img src="/images/dubles.jpg" alt="dubl√™" title="dubl√™s"></p>
<p>Normalmente quando falamos de <em>mocks</em>, estamos nos referindo a um componente simulado de <em>software</em>. Por√©m existem v√°rios tipos de simula√ß√µes que podem ser feitas que podem ajudar a escrever os testes.</p>
<blockquote>
<p>‚ö†Ô∏è Os c√≥digos deste post utilizam <code>pytest-mock</code> e <code>requests</code> que s√£o libs de terceiros. Certifique-se de t√™-las instaladas caso decida rodar os c√≥digos.</p>
</blockquote>
<p>Como base para nossos testes, vamos definir a seguinte fun√ß√£o que realiza uma requisi√ß√£o web e retorna o conte√∫do de sua resposta. Por√©m caso algum erro ocorra, deve retornar um conte√∫do vazio e imprimir um alerta com o erro ocorrido.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> logging <span style="color:#f92672">import</span> warning
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_page_content</span>(url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, timeout<span style="color:#f92672">=</span>timeout)
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">IOError</span> <span style="color:#66d9ef">as</span> exc:
</span></span><span style="display:flex;"><span>        warning(exc)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span>text
</span></span></code></pre></div><p>Vamos conceituar cada um dos tipos de dubl√™s de teste e como poderiam ser utilizados para testar a fun√ß√£o apresentada acima.</p>
<blockquote>
<p>üí° As defini√ß√µes em ingl√™s foram retiradas de: <a href="https://martinfowler.com/bliki/TestDouble.html">https://martinfowler.com/bliki/TestDouble.html</a>.</p>
</blockquote>
<h2 id="dummy">Dummy</h2>
<blockquote>
<p>Dummy objects are passed around but never actually used. Usually they are just used to fill parameter lists.</p>
</blockquote>
<p>S√£o objetos &ldquo;dummy&rdquo;, ou seja falsos, fict√≠cios, que ser√£o utilizados apenas para preencher a lista de par√¢metros obrigat√≥rios, mas n√£o ser√£o utilizados.</p>
<h2 id="fake">Fake</h2>
<blockquote>
<p>Fake objects actually have working implementations, but usually take some shortcut which makes them not suitable for production (an InMemoryTestDatabase is a good example).</p>
</blockquote>
<p>S√£o objetos falsos, com implementa√ß√µes concretas, por√©m simplificadas. Um bom exemplo s√£o objetos que representam bancos de dados ou arquivos, por√©m com implementa√ß√µes em mem√≥ria.</p>
<p>Para utiliza√ß√£o da t√©cnica de objetos <em>fakes</em>, vamos primeiro fazer uma invers√£o de depend√™ncia no c√≥digo de modo a receber o objeto respons√°vel por realizar as requisi√ß√µes como par√¢metro.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> logging <span style="color:#f92672">import</span> warning
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">requests_fetcher</span>(url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, timeout<span style="color:#f92672">=</span>timeout)
</span></span><span style="display:flex;"><span>    response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_page_content</span>(fetcher, url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> fetcher(url, timeout)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">IOError</span> <span style="color:#66d9ef">as</span> exc:
</span></span><span style="display:flex;"><span>        warning(exc)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span>text
</span></span></code></pre></div><p>Nos testes podemos substituir a fun√ß√£o <code>fetcher</code>, por uma fun√ß√£o <em>fake</em> com uma implementa√ß√£o simplificada.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestFetchPageContentFake</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_request_is_ok</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># preparamos nosso teste definindo o retorno esperado</span>
</span></span><span style="display:flex;"><span>        expected_content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;page_content&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fake_fetcher</span>(url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># definimos uma fun√ß√£o falsa que substituir√° a requisi√ß√£o real</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># definimos objeto de resposta falso com o coonte√∫do definido</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># como conte√∫do esperado</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FakeResponse</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>                    self<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> expected_content
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># a fun√ß√£o retornar√° este objeto como resposta quando invocada</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> FakeResponse()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># por fim fazemos a afirma√ß√£o do nosso teste</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># verificamos se o resultado da fun√ß√£o √© igual ao contepudo esperado</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> (
</span></span><span style="display:flex;"><span>            fetch_page_content(fake_fetcher, <span style="color:#e6db74">&#34;dummy url&#34;</span>) <span style="color:#f92672">==</span> expected_content
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_request_fail</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># em nossa prepara√ß√£o estamos definindo que o retorno esperado</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># √© uma string vazia</span>
</span></span><span style="display:flex;"><span>        expected_content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># nossa fun√ß√£o fake agora √© simplificada lan√ßando uma exce√ß√£o</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># pois esse √© o comportamento esperado se essa requisi√ß√£o fosse real</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fake_fetcher</span>(url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">IOError</span>(<span style="color:#e6db74">&#34;Failure on request&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># por fim comparamos se o resultado obtido foi o mesmo do esperado</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> (
</span></span><span style="display:flex;"><span>            fetch_page_content(fake_fetcher, <span style="color:#e6db74">&#34;dummy url&#34;</span>) <span style="color:#f92672">==</span> expected_content
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><h2 id="stub">Stub</h2>
<blockquote>
<p>Stubs provide canned answers to calls made during the test, usually not responding at all to anything outside what&rsquo;s programmed in for the test.</p>
</blockquote>
<p>S√£o substitutos que fornecem respostas previamente definidas, simulando assim o comportamento esperado.</p>
<p>Considerando novamente nossa fun√ß√£o original:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> logging <span style="color:#f92672">import</span> warning
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fetch_page_content</span>(url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>        response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, timeout<span style="color:#f92672">=</span>timeout)
</span></span><span style="display:flex;"><span>        response<span style="color:#f92672">.</span>raise_for_status()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">IOError</span> <span style="color:#66d9ef">as</span> exc:
</span></span><span style="display:flex;"><span>        warning(exc)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span>text
</span></span></code></pre></div><p>Nosso teste substituir√° o m√©todo get da biblioteca requests, retornando respostas programadas e em alguns casos lan√ßando uma exce√ß√£o.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestFetchPageContentStub</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_request_is_ok</span>(self, mocker):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># preparamos nosso teste definindo o retorno esperado</span>
</span></span><span style="display:flex;"><span>        expected_content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;page_content&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># substituimos o m√©todo get da biblioteca requests por um stub</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># o par√¢metro autospec garante que caso cometemos</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># algum erro de digita√ß√£o</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># a especifica√ß√£o da fun√ß√£o ser√° respeitado</span>
</span></span><span style="display:flex;"><span>        mocked_get <span style="color:#f92672">=</span> mocker<span style="color:#f92672">.</span>patch<span style="color:#f92672">.</span>object(requests, <span style="color:#e6db74">&#34;get&#34;</span>, autospec<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># definimos que o objeto retornado possuir√° c√≥digo de status 200</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>return_value<span style="color:#f92672">.</span>status_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># o objeto retornado possuir√° o texto esperado</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>return_value<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> expected_content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># comparamos o retorno esperado e o obtido</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> fetch_page_content(<span style="color:#e6db74">&#34;dummy url&#34;</span>) <span style="color:#f92672">==</span> expected_content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_request_fail</span>(self, mocker):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># em nossa prepara√ß√£o estamos definindo que o retorno esperado</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># √© uma string vazia</span>
</span></span><span style="display:flex;"><span>        expected_content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># substituimos o m√©todo get por um stub</span>
</span></span><span style="display:flex;"><span>        mocked_get <span style="color:#f92672">=</span> mocker<span style="color:#f92672">.</span>patch<span style="color:#f92672">.</span>object(requests, <span style="color:#e6db74">&#34;get&#34;</span>, autospec<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># quando invocado o m√©todo raise_for_status do retorno do nosso stub</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># uma exce√ß√£o ser√° lan√ßada</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>return_value<span style="color:#f92672">.</span>raise_for_status<span style="color:#f92672">.</span>side_effect <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            requests<span style="color:#f92672">.</span>HTTPError()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># por fim comparamos se o resultado obtido foi o mesmo do esperado</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> fetch_page_content(<span style="color:#e6db74">&#34;dummy url&#34;</span>) <span style="color:#f92672">==</span> expected_content
</span></span></code></pre></div><h2 id="mocks">Mocks</h2>
<blockquote>
<p>Mocks are pre-programmed with expectations which form a specification of the calls they are expected to receive. They can throw an exception if they receive a call they don&rsquo;t expect and are checked during verification to ensure they got all the calls they were expecting.</p>
</blockquote>
<p>A preocupa√ß√£o de mocks √© verificar se o comportamento do dubl√™ foi o esperado, fazendo asser√ß√µes se o <em>mock</em> foi invocado, se os par√¢metros na invoca√ß√£o foram corretos e o n√∫mero de vezes em que foi invocado. N√£o h√° inten√ß√£o de simular o retorno de valores, mas somente verificar o comportamento.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestFetchPageContentMock</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_timeout_is_not_passed</span>(self, mocker):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;&#39;&#39;when invoked, default timeout should be considered&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># preparamos nosso teste modificando o m√©todo get por um mock</span>
</span></span><span style="display:flex;"><span>        dummy_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dummy url&#34;</span>
</span></span><span style="display:flex;"><span>        mocked_get <span style="color:#f92672">=</span> mocker<span style="color:#f92672">.</span>patch<span style="color:#f92672">.</span>object(requests, <span style="color:#e6db74">&#34;get&#34;</span>, autospec<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># invocamos nossa fun√ß√£o</span>
</span></span><span style="display:flex;"><span>        fetch_page_content(dummy_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># a asser√ß√£o √© feita verificando se o m√©todo foi chamado</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># com os par√¢metros corretos</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ou seja, verificamos o comportamento do m√©todo</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>assert_called_once_with(dummy_url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_called_verify_if_status_code_is_ok</span>(self, mocker):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># preparamos nosso teste modificando o m√©todo get por um mock</span>
</span></span><span style="display:flex;"><span>        dummy_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dummy url&#34;</span>
</span></span><span style="display:flex;"><span>        mocked_get <span style="color:#f92672">=</span> mocker<span style="color:#f92672">.</span>patch<span style="color:#f92672">.</span>object(requests, <span style="color:#e6db74">&#34;get&#34;</span>, autospec<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># invocamos nossa fun√ß√£o</span>
</span></span><span style="display:flex;"><span>        fetch_page_content(dummy_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># a asser√ß√£o √© feita verificando se o m√©todo raise_for_status</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># do retorno do nosso m√©todo</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># foi invocado somente uma vez</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>return_value<span style="color:#f92672">.</span>raise_for_status<span style="color:#f92672">.</span>assert_called_once()
</span></span></code></pre></div><h2 id="spies">Spies</h2>
<blockquote>
<p>Spies are stubs that also record some information based on how they were called. One form of this might be an email service that records how many messages it was sent.</p>
</blockquote>
<p>S√£o stubs mas &ldquo;espionam&rdquo; como s√£o invocados e mant√©m isto como informa√ß√£o a ser utilizada nas asser√ß√µes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestFetchPageContentSpy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_request_is_ok</span>(self, mocker):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># preparamos os testes definindo os estados esperados</span>
</span></span><span style="display:flex;"><span>        expected_content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;page_content&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># definimos um espi√£o para substituir a fun√ß√£o get</span>
</span></span><span style="display:flex;"><span>        mocked_get <span style="color:#f92672">=</span> mocker<span style="color:#f92672">.</span>patch(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;requests.get&#34;</span>, MagicMock(wraps<span style="color:#f92672">=</span>requests<span style="color:#f92672">.</span>get)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># assim como um stub, definimos os valores a serem retornados</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>return_value<span style="color:#f92672">.</span>status_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>return_value<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> expected_content
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># verificamos se o valor retornado √© o mesmo do esperado</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> fetch_page_content(<span style="color:#e6db74">&#34;dummy url&#34;</span>) <span style="color:#f92672">==</span> expected_content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_request_fail</span>(self, mocker):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Como estamos testando estados, at√© aqui temos nosso substituto</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># como um stub</span>
</span></span><span style="display:flex;"><span>        expected_content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        mocked_get <span style="color:#f92672">=</span> mocker<span style="color:#f92672">.</span>patch(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;requests.get&#34;</span>, MagicMock(wraps<span style="color:#f92672">=</span>requests<span style="color:#f92672">.</span>get)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>return_value<span style="color:#f92672">.</span>raise_for_status<span style="color:#f92672">.</span>side_effect <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>            requests<span style="color:#f92672">.</span>HTTPError()
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">assert</span> fetch_page_content(<span style="color:#e6db74">&#34;dummy url&#34;</span>) <span style="color:#f92672">==</span> expected_content
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_when_timeout_is_not_passed</span>(self, mocker):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;when invoked, default timeout should be considered&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># a diferen√ßa est√° aqui, pois podemos utilizar nosso espi√£o</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># para verificar como ele foi invocado</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># e quais par√¢metros foram utilizados</span>
</span></span><span style="display:flex;"><span>        dummy_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://example.com&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        mocked_get <span style="color:#f92672">=</span> mocker<span style="color:#f92672">.</span>patch(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;requests.get&#34;</span>, MagicMock(wraps<span style="color:#f92672">=</span>requests<span style="color:#f92672">.</span>get)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># se n√£o passarmos um retorno,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># o espi√£o se comportar√° como a fun√ß√£o original</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>return_value<span style="color:#f92672">.</span>status_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        fetch_page_content(dummy_url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># a asser√ß√£o verifica como a fun√ß√£o se comporta</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># ou seja espi√µes s√£o stubs mas &#34;espionam&#34; o comportamento</span>
</span></span><span style="display:flex;"><span>        mocked_get<span style="color:#f92672">.</span>assert_called_once_with(dummy_url, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><h2 id="conclus√£o">Conclus√£o</h2>
<p>Temos dois tipos de verifica√ß√µes quando utilizamos dubl√™s. Verifica√ß√µes de comportamento como em mocks e verifica√ß√µes de estado como em stubs. Qual o tipo de dubl√™ que ser√° utilizado, vai depender do que voc√™ est√° testando.</p>
<p>Os c√≥digos aqui apresentados s√£o apenas exemplos de como implementar os padr√µes de dubl√™s, podendo ser implementados de forma diferente.</p>
<p>Ent√£o √© isso pessoal!</p>
<p>At√© a pr√≥xima!</p>
<p>{}&rsquo;s</p>

  </div>

  
<div>
  <ul class="tags">
  <li>
    <a href="http://cassiobotaro.dev/tags/python/" class="tag-link">python</a>
  </li>
  
  <li>
    <a href="http://cassiobotaro.dev/tags/tests/" class="tag-link">tests</a>
  </li>
  
  <li>
    <a href="http://cassiobotaro.dev/tags/dubles/" class="tag-link">dubles</a>
  </li>
  </ul>
</div>



  <div class="share-buttons">
  <a class="twitter-share-button"
     href="#"
     title="Share on Twitter"
     data-url="http://cassiobotaro.dev/post/dubles-de-teste/"
     data-text="Dubl√™s de testes"><i class="fab fa-twitter"></i></a>

  <a class="linkedin-share-button"
     href="#"
     title="Share on LinkedIn"
     data-url="http://cassiobotaro.dev/post/dubles-de-teste/"
     data-text="Dubl√™s de testes"><i class="fab fa-linkedin-in"></i></a>

  <a class="facebook-share-button"
     href="#"
     title="Share on Facebook"
     data-url="http://cassiobotaro.dev/post/dubles-de-teste/"
     data-text="Dubl√™s de testes"><i class="fab fa-facebook"></i></a>

  <a class="telegram-share-button"
     href="#"
     title="Share on Telegram"
     data-url="http://cassiobotaro.dev/post/dubles-de-teste/"
     data-text="Dubl√™s de testes"><i class="fab fa-telegram"></i></a>

  <a class="pinterest-share-button"
     href="#"
     title="Share on Pinterest"
     data-url="http://cassiobotaro.dev/post/dubles-de-teste/"
     data-text="Dubl√™s de testes"><i class="fab fa-pinterest"></i></a>
</div>


  <div class="comments">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "importnone" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>
  </main>

  <footer>
  <div>
    <p>
      &copy; C√°ssio Botaro 2023

      &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

      &middot; Build with <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://themes.gohugo.io/soho/" target="_blank">Soho</a> theme
    </p>
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>


  <script src="/js/jquery.min.js"></script>
  <script src="/js/soho.js"></script>

  

  
</body>
</html>
